{
    "sha": "e32af9a5de4f103cf27576979971e955cae2f83b",
    "node_id": "C_kwDOKZwcvtoAKGUzMmFmOWE1ZGU0ZjEwM2NmMjc1NzY5Nzk5NzFlOTU1Y2FlMmY4M2I",
    "commit": {
        "author": {
            "name": "Olivier Fuxet",
            "email": "ofux@users.noreply.github.com",
            "date": "2024-10-03T09:08:32Z"
        },
        "committer": {
            "name": "GitHub",
            "email": "noreply@github.com",
            "date": "2024-10-03T09:08:32Z"
        },
        "message": "improve-perf-v_contribution_data (#1186)\n\n* Improve perf of v_contribution_data\r\n\r\n* Update dumps",
        "tree": {
            "sha": "7317a7d9769cc8514aa98ad6d1b37ec55dda71b3",
            "url": "https://api.github.com/repos/onlydustxyz/marketplace-api/git/trees/7317a7d9769cc8514aa98ad6d1b37ec55dda71b3"
        },
        "url": "https://api.github.com/repos/onlydustxyz/marketplace-api/git/commits/e32af9a5de4f103cf27576979971e955cae2f83b",
        "comment_count": 0,
        "verification": {
            "verified": true,
            "reason": "valid",
            "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJm/l8QCRC1aQ7uu5UhlAAAqhAQAAgvP+SzgV9JUbWtGLZF2NeO\n0WVh98Wl1UB69oySYqG+O5iDb5OiyoqmP2QNdJdMLoi48L8JrdX9eIFbSRG38Q+0\npfZtU0GbbKtLIwoD+kEMXqMIwz6EZpWXpB1mRwnBD14YkSQbkoGWARgImn8MUItQ\ndtxnPbAKMBkmetKUgte6HzNxLMjPfh8rFbBW09jyd7XKG2fhbFoDDmkjL30zNmIE\nRrK37DJTKKroQQkR9FbVvdHBM9j8EFctzLcItkGmo+1INBXHSURviCxbKoSe71/f\n4pn34EknKOBYbv3TbcX2ekUJswfexhjdaRJJXgFVGBDdvJBqL5m8qJuaBZS7yEUh\nj2oha1fJAyUZVmOBvmkeNTzbISJzPTTomwhcEZixz28Gmy+YJSsHs4O2LYypxT+C\ndls3a1K3ZZaUJ9FEjy9WAHfFn5+S0uupVbEm7h2ITtrsSwuRwQVq0cav4GHCIL1k\njvUayaGRey6q3fkJDgpMQy/uTumNF4jGXeHwwbVmv9Oj52wWG6NlC4TxkaSsnd/q\nhJzr+aRO1EyBjaOOWMkoJrFRA8lq6GhFzJIflPVyR0qwPYGBpz47IFEiOiTeueRD\nPm0z5VIcS5DdMEdjHegVTniPQs4YgdzZ86VEQ++1+YYQEbLZ0lb9rTKXgAqitHk+\nIwxyT9HmdDkBhbM2HfCT\n=c4vc\n-----END PGP SIGNATURE-----\n",
            "payload": "tree 7317a7d9769cc8514aa98ad6d1b37ec55dda71b3\nparent 1523709fd0977b76aca8c6e0067a310bb907603b\nauthor Olivier Fuxet <ofux@users.noreply.github.com> 1727946512 +0200\ncommitter GitHub <noreply@github.com> 1727946512 +0200\n\nimprove-perf-v_contribution_data (#1186)\n\n* Improve perf of v_contribution_data\r\n\r\n* Update dumps"
        }
    },
    "url": "https://api.github.com/repos/onlydustxyz/marketplace-api/commits/e32af9a5de4f103cf27576979971e955cae2f83b",
    "html_url": "https://github.com/onlydustxyz/marketplace-api/commit/e32af9a5de4f103cf27576979971e955cae2f83b",
    "comments_url": "https://api.github.com/repos/onlydustxyz/marketplace-api/commits/e32af9a5de4f103cf27576979971e955cae2f83b/comments",
    "author": {
        "login": "ofux",
        "id": 595505,
        "node_id": "MDQ6VXNlcjU5NTUwNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/595505?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ofux",
        "html_url": "https://github.com/ofux",
        "followers_url": "https://api.github.com/users/ofux/followers",
        "following_url": "https://api.github.com/users/ofux/following{/other_user}",
        "gists_url": "https://api.github.com/users/ofux/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ofux/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ofux/subscriptions",
        "organizations_url": "https://api.github.com/users/ofux/orgs",
        "repos_url": "https://api.github.com/users/ofux/repos",
        "events_url": "https://api.github.com/users/ofux/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ofux/received_events",
        "type": "User",
        "site_admin": false
    },
    "committer": {
        "login": "web-flow",
        "id": 19864447,
        "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
        "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/web-flow",
        "html_url": "https://github.com/web-flow",
        "followers_url": "https://api.github.com/users/web-flow/followers",
        "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
        "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
        "organizations_url": "https://api.github.com/users/web-flow/orgs",
        "repos_url": "https://api.github.com/users/web-flow/repos",
        "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
        "received_events_url": "https://api.github.com/users/web-flow/received_events",
        "type": "User",
        "site_admin": false
    },
    "parents": [
        {
            "sha": "1523709fd0977b76aca8c6e0067a310bb907603b",
            "url": "https://api.github.com/repos/onlydustxyz/marketplace-api/commits/1523709fd0977b76aca8c6e0067a310bb907603b",
            "html_url": "https://github.com/onlydustxyz/marketplace-api/commit/1523709fd0977b76aca8c6e0067a310bb907603b"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 61,
        "deletions": 0
    },
    "files": [
        {
            "sha": "4ead64166bf77f260f7c03aea0f7d2dd05e52db9",
            "filename": "bootstrap/src/test/resources/database/dumps/IT_data.dump",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/onlydustxyz/marketplace-api/blob/e32af9a5de4f103cf27576979971e955cae2f83b/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_data.dump",
            "raw_url": "https://github.com/onlydustxyz/marketplace-api/raw/e32af9a5de4f103cf27576979971e955cae2f83b/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_data.dump",
            "contents_url": "https://api.github.com/repos/onlydustxyz/marketplace-api/contents/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_data.dump?ref=e32af9a5de4f103cf27576979971e955cae2f83b"
        },
        {
            "sha": "5e4ff74be8aabf38480f00525bb9b7f9825d28d0",
            "filename": "bootstrap/src/test/resources/database/dumps/IT_schema.dump",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/onlydustxyz/marketplace-api/blob/e32af9a5de4f103cf27576979971e955cae2f83b/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_schema.dump",
            "raw_url": "https://github.com/onlydustxyz/marketplace-api/raw/e32af9a5de4f103cf27576979971e955cae2f83b/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_schema.dump",
            "contents_url": "https://api.github.com/repos/onlydustxyz/marketplace-api/contents/bootstrap%2Fsrc%2Ftest%2Fresources%2Fdatabase%2Fdumps%2FIT_schema.dump?ref=e32af9a5de4f103cf27576979971e955cae2f83b"
        },
        {
            "sha": "fbed7164d56c5d553cb3e1fd21381346e59b7a8e",
            "filename": "infrastructure/postgres-adapter/src/main/resources/db/changelog/changelogs/00000355_improve_perf_v_contribution_data.sql",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/onlydustxyz/marketplace-api/blob/e32af9a5de4f103cf27576979971e955cae2f83b/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fchangelogs%2F00000355_improve_perf_v_contribution_data.sql",
            "raw_url": "https://github.com/onlydustxyz/marketplace-api/raw/e32af9a5de4f103cf27576979971e955cae2f83b/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fchangelogs%2F00000355_improve_perf_v_contribution_data.sql",
            "contents_url": "https://api.github.com/repos/onlydustxyz/marketplace-api/contents/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fchangelogs%2F00000355_improve_perf_v_contribution_data.sql?ref=e32af9a5de4f103cf27576979971e955cae2f83b",
            "patch": "@@ -0,0 +1,59 @@\n+CREATE OR REPLACE VIEW bi.v_contribution_data AS\n+SELECT v.*, md5(v::text) as hash\n+from (with ranked_project_github_repos_relationship AS (SELECT *, row_number() OVER (PARTITION BY github_repo_id ORDER BY project_id) as row_number\n+                                                        FROM project_github_repos),\n+           registered_users as (select u.id             as id,\n+                                       u.github_user_id as github_user_id,\n+                                       kyc.country      as country\n+                                from iam.users u\n+                                         join accounting.billing_profiles_users bpu on bpu.user_id = u.id\n+                                         join accounting.kyc on kyc.billing_profile_id = bpu.billing_profile_id)\n+      select c.id                                                                                             as contribution_id,\n+             c.repo_id                                                                                        as repo_id,\n+             p.id                                                                                             as project_id,\n+             p.slug                                                                                           as project_slug,\n+             c.contributor_id                                                                                 as contributor_id,\n+             ru.id                                                                                            as contributor_user_id,\n+             ru.country                                                                                       as contributor_country,\n+             c.created_at                                                                                     as timestamp,\n+             c.status                                                                                         as contribution_status,\n+             date_trunc('day', c.created_at)                                                                  as day_timestamp,\n+             date_trunc('week', c.created_at)                                                                 as week_timestamp,\n+             date_trunc('month', c.created_at)                                                                as month_timestamp,\n+             date_trunc('quarter', c.created_at)                                                              as quarter_timestamp,\n+             date_trunc('year', c.created_at)                                                                 as year_timestamp,\n+             c.created_at = first.created_at                                                                  as is_first_contribution_on_onlydust,\n+             (c.type = 'ISSUE')::int                                                                          as is_issue,\n+             (c.type = 'PULL_REQUEST')::int                                                                   as is_pr,\n+             (c.type = 'CODE_REVIEW')::int                                                                    as is_code_review,\n+             array_agg(distinct lfe.language_id) filter ( where lfe.language_id is not null )                 as language_ids,\n+             array_agg(distinct pe.ecosystem_id) filter ( where pe.ecosystem_id is not null )                 as ecosystem_ids,\n+             array_agg(distinct pp.program_id) filter ( where pp.program_id is not null )                     as program_ids,\n+             array_agg(distinct ppc.project_category_id) filter ( where ppc.project_category_id is not null ) as project_category_ids,\n+             string_agg(distinct lfe.name, ' ')                                                               as languages\n+      from indexer_exp.contributions c\n+               left join ranked_project_github_repos_relationship pgr on pgr.github_repo_id = c.repo_id and pgr.row_number = 1\n+               left join projects p on p.id = pgr.project_id\n+               join lateral (select cc.contributor_id, min(cc.created_at) as created_at\n+                             from indexer_exp.contributions cc\n+                             where cc.contributor_id = c.contributor_id\n+                             group by cc.contributor_id) first on true\n+               left join lateral ( select distinct lfe_1.language_id, l.name\n+                                   from language_file_extensions lfe_1\n+                                            join languages l on l.id = lfe_1.language_id\n+                                   where lfe_1.extension = any (c.main_file_extensions)) lfe on true\n+               left join projects_ecosystems pe on pe.project_id = p.id\n+               left join v_programs_projects pp on pp.project_id = p.id\n+               left join projects_project_categories ppc on ppc.project_id = p.id\n+               left join registered_users ru on ru.github_user_id = c.contributor_id\n+      group by c.id,\n+               c.repo_id,\n+               p.id,\n+               p.slug,\n+               c.contributor_id,\n+               c.created_at,\n+               c.type,\n+               c.status,\n+               first.created_at,\n+               ru.id,\n+               ru.country) v;\n\\ No newline at end of file"
        },
        {
            "sha": "cef59ca7c401ea3e6c70a66e49a5c65cce24be23",
            "filename": "infrastructure/postgres-adapter/src/main/resources/db/changelog/db.changelog-master.yaml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/onlydustxyz/marketplace-api/blob/e32af9a5de4f103cf27576979971e955cae2f83b/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fdb.changelog-master.yaml",
            "raw_url": "https://github.com/onlydustxyz/marketplace-api/raw/e32af9a5de4f103cf27576979971e955cae2f83b/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fdb.changelog-master.yaml",
            "contents_url": "https://api.github.com/repos/onlydustxyz/marketplace-api/contents/infrastructure%2Fpostgres-adapter%2Fsrc%2Fmain%2Fresources%2Fdb%2Fchangelog%2Fdb.changelog-master.yaml?ref=e32af9a5de4f103cf27576979971e955cae2f83b",
            "patch": "@@ -567,3 +567,5 @@ databaseChangeLog:\n       file: db/changelog/changelogs/00000353_move_materialized_views_to_projections.sql\n   - include:\n       file: db/changelog/changelogs/00000354_improve_select_function_perfs.sql\n+  - include:\n+      file: db/changelog/changelogs/00000355_improve_perf_v_contribution_data.sql"
        }
    ]
}